# Практикуем SQL, становимся дата саентистами

Чтобы хорошо овладеть SQL, нужно, в частности, прорешать некоторое количество задач, чтобы привыкнуть к принципам работы этого языка. 

Я предлагаю вам порешать задачки до пары. Тогда вы сможете комфортно порешать задачи дома с удобной вам скоростью, а в понедельник 8 февраля мы разберём наиболее интересные/сложные/непонятные задачи.

6 февраля я буду рассказывать про синтаксис SQL, но задачи скидываю раньше, чтобы вы при желании могли начать уже сейчас.

*Пока что на этой странице опубликованы задачи, которые мы решали со студентами в прошлом году. Можно решать их уже сейчас, чуть позже я добавлю еще задач на нетривиальную обработку данных окнами/группировками/использование различных встроенных функций SQL.*


## Ставим постгрес

В целом, вы можете использовать любую СУБД, поддерживающую оконные функции (НЕ sqlite), но лучше, когда все пишут код на одном диалекте (можно советоваться друг с другом, да и мне так проще).

Поэтому установите PostgreSQL (одну из последних версий - 13, 12, 11). PostgreSQL - мощная система управления базами данных, в том числе она поддерживает возможности, которых нет в SQLite (например, те же оконные функции). Установка может отнять у вас некоторое время, но оно того стоит :)

Как делать запросы к БД:
* через консоль (если вы ценитель)
* через pgAdmin (он обычно поставляется вместе с постгресом под винду/мак)
* поставить DataGrip https://www.jetbrains.com/datagrip/ (ваша студенческая лицензия распространяется и на него) - это удобный инструмент для хождения в различные БД, не только постгрес
* (**рекомендуемая опция**) использовать Data Sources в Pycharm: https://www.jetbrains.com/help/pycharm/connecting-to-a-database.html#connect-to-postgresql-database (по сути, это DataGrip, встроенный в Pycharm)


Итого план такой: 

1. Поставьте PostgreSQL (лучше всего использовать Interactive Installer by EDB - для винды https://www.postgresql.org/download/windows/, для мака https://www.postgresql.org/download/macosx/). У вас на компьютере запустится сервер баз данных, к которому нельзя подключиться извне, но с ним можно играться на этом же компьютере, что вы и будете делать. Все параметры при установке можно оставить как есть, но важно запомнить пароль для пользователя "postgres”  вашего сервера базы данных, который вам нужно будет придумать. Вместе с ним была создана база postgres, к которой этот пользователь имеет полный доступ.
2. Подключаемся к вашей базе данных (https://www.jetbrains.com/help/pycharm/connecting-to-a-database.html#connect-to-postgresql-database, нужно указать Host=localhost, Port=5432, User=postgres, Password=ваш пароль).
3. Теперь вы можете выполнить какой-нибудь запрос к вашей БД (https://www.jetbrains.com/help/datagrip/run-a-query.html), например, “select 1;”) и начинать решать задачи.



## Задачи

### 0. Заполняем базу данными

1. Выполните запрос к базе данных:


```
ccreate table users
(
    id uuid primary key, -- уникальный id пользователя
    created timestamp -- время регистрации пользователя
);

create table orders
(
    id uuid primary key, -- уникальный id заказа
    user_id uuid references users(id), -- id пользователя, совершившего заказ, из таблицы users
    city varchar, -- город совершения заказа
    created timestamp -- время заказа
);
```


2. Импортируйте файлы [users.csv](https://raw.githubusercontent.com/esolovev/ling2020/main/lectures/29_users.csv) и [orders.csv](https://raw.githubusercontent.com/esolovev/ling2020/main/lectures/29_orders.csv) (именно в таком порядке) в базу через DataGrip (https://www.jetbrains.com/datagrip/features/importexport.html https://stackoverflow.com/a/52148057). Не забудьте про галочку First row is header.

![](https://i.imgur.com/YhmSsaN.png)

![](https://camo.githubusercontent.com/b40dd9d31dc50be274bef7a3ab91550c6d177aeb/68747470733a2f2f692e696d6775722e636f6d2f58436c7864734e2e706e67)




### 1. Извлекаем данные
1. Выведите 5 произвольных заказов.
2. Выведите 5 первых заказов.
3. Выведите общее количество заказов, количество встретившихся городов и количество встретившихся пользователей.
4. Выведите 15 последних заказов в Москве.
5. Выведите 5 первых и 5 последних заказов одним запросом (вам поможет UNION/UNION ALL https://www.techonthenet.com/sql/union_all.php)

### 2. Группируем данные
1. Для каждого пользователя выведите количество его заказов. Отсортируйте результат по убыванию количества заказов.
2. Для каждого пользователя, выведите количество его заказов за последнюю неделю (https://www.postgresqltutorial.com/postgresql-now/).
3. Для каждого пользователя выведите количество его заказов за последнюю неделю, если это количество больше 1.
4. Выведите количество заказов по дням (https://www.postgresql.org/docs/9.0/functions-datetime.html, https://stackoverflow.com/questions/6195439/postgres-how-do-you-round-a-timestamp-up-or-down-to-the-nearest-minute#6195521)
5. Добавьте к результату предыдущего запроса количество пользователей, совершивших хотя бы один заказ в этот день (эта метрика называется DAU - Daily Active Users)
6. Выведите количество пользователей, сделавших заказы как минимум в двух городах (за всю историю).
7. Посчитайте величину "среднее количество городов, в которых делает заказ пользователь" подневно (например, если в день Х пользователь A совершал заказы в двух разных городах, а пользователи B и C каждый в каком-то одном городе, метрика в этот день будет равна 4/3 = 1.33..)
8. Назовём пользователя активированным в день Х, если в этот день он совершил свой первый заказ. Посчитайте количество активированных пользователей по дням.

### 3. Джойним таблички
1. Вычислите для каждого пользователя величину "время, прошедшее от регистрации до первого заказа".
2. Посчитайте среднее значение этой величины для каждого города (под городом пользователя подразумевается город его первого заказа).
3. Назовём пользователя принадлежащего когорте Х, если он совершил свой первый заказ в день Х. Постройте таблицу вида "день, когорта, retention", где retention когорты Х в день Y - доля пользователей, совершивших хотя бы один заказ в день Y, среди пользователей, совершивших первый заказ в день X. (подробнее о когортном анализе здесь https://en.wikipedia.org/wiki/Cohort_analysis https://gopractice.ru/cohort_analysis/)

### 4. Оконные функции
1. Выведите 10% первых заказов (примечание: нужно сделать это за один запрос, а не посчитать отдельно количество строк в таблице, поделить его на 10 и вставить в другой запрос)
2. Выполните задание 3.3 с помощью оконных функций.
